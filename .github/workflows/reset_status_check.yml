name: Reset Status Check File

on:
  workflow_run:
    workflows: 
      - "CI Pipeline - Build and Test"
      - "Deploy - Waiting Approval then Deploy"
    types:
      - completed

jobs:
  reset-status:
    runs-on: ubuntu-22.04

    steps:
    
      - name: Check CI and Deploy Pipeline Status
        run: |
          # Verificando se o arquivo event.json existe
          if [ ! -f "$GITHUB_EVENT_PATH" ]; then
            echo "File $GITHUB_EVENT_PATH does not exist."
            exit 1
          fi
          
          # Imprimindo o conteúdo do event.json para depuração
          echo "Contents of $GITHUB_EVENT_PATH:"
          cat $GITHUB_EVENT_PATH

          # Extraindo informações usando jq
          CI_COMPLETED=$(jq -r '.workflow_runs[] | select(.name=="CI Pipeline - Build and Test") | .conclusion' $GITHUB_EVENT_PATH)
          DEPLOY_COMPLETED=$(jq -r '.workflow_runs[] | select(.name=="Deploy - Waiting Approval then Deploy") | .conclusion' $GITHUB_EVENT_PATH)      
          
          echo "CI Pipeline Conclusion: $CI_COMPLETED"
          echo "Deploy Pipeline Conclusion: $DEPLOY_COMPLETED"

          if [ "$CI_COMPLETED" = "success" ]; then
            echo "CI pipeline completed successfully."
          else
            echo "CI pipeline did not complete successfully."
          fi
          
          if [ "$DEPLOY_COMPLETED" = "success" ]; then
            echo "Deploy pipeline completed successfully."
            echo "reset_status=true" > status_check.txt
          elif [ -z "$DEPLOY_COMPLETED" ]; then
            echo "Deploy pipeline was not run."
            echo "reset_status=true" > status_check.txt
          else
            echo "Deploy pipeline did not complete successfully."
            echo "reset_status=false" > status_check.txt
          fi
        
      - name: Download Status Check File
        uses: actions/download-artifact@v4
        with:
          name: status-check
          path: ./status      

      - name: Upload Status Check File
        uses: actions/upload-artifact@v4
        with:
          name: status-check
          path: status_check.txt

      - name: Reset status check file
        if: steps.check_pipelines.outputs.reset_status == 'true'
        run: echo "false" > status_check.txt
